!function(){"use strict";
/**
     * @author Michael Seltenreich <seltenmusic@gmail.com>
     * @version 1.2.0
     * @license
     * <pre>Copyright 2020 Michael Seltenreich
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     * http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.</pre>*/const t="undefined"==typeof window?"server":"browser";let e,i,s,r,n;"server"==t&&(e=require("fs"),i=require("xml2js").parseString,s=require("midi-parser-js")),r="server"==t?function(t,i,s,r){e.writeFile(i+t,s,(function(t){if(t)return console.log(t)}))}:function(t,e,i,s="text/plain"){const r=new Blob([i],{type:s}),n=document.createElement("a");n.download=t,n.href=window.URL.createObjectURL(r),n.onclick=function(t){setTimeout((()=>{window.URL.revokeObjectURL(this.href)}),1500)},n.click(),n.remove()},n="server"==t?function(t){return e.readFileSync(t)}:function(t,e,i){var s=document.createElement("input");s.setAttribute("type","file");var r=document.createElement("a");r.setAttribute("href",""),r.innerText="Select File",r.onclick=function(){return s.click(),!1},r.click()};class h{constructor(t){for(let e=0;e<t.length;e++)t[e]<0&&(t[e]=0);this.n_init=t,this.N=t.reduce(((t,e)=>e+t)),this.k=t.length,this.initialize()}initialize(t="simple"){this.occurrence=[...this.n_init],this.word=Array(this.N).fill(0),this.alphabet=Array(this.k).fill(0),this.alphabet=this.alphabet.map(((t,e,i)=>e)),this.run=Array(this.N).fill(0),this.first_letter=0,this.last_letter=this.k-1,this.__set_letter_bounds(t),"simple"!=t&&(this.word=[this.word[0]].concat(Array(this.N-1).fill(this.last_letter)))}__set_letter_bounds(t){let e=!1;for(let i=0;i<this.k;i++)!e&&this.occurrence[i]>0&&(e=!0,this.occurrence[i]-=1,this.word[0]=i,this.first_letter=i),"simple"!=t&&0==this.occurrence[i]&&this.__remove_letter(i);this.last_letter=this.alphabet?Math.max.apply(Math,this.alphabet):0}*execute(t="simple"){this.initialize(t),"simple"==t?yield*this._simple_fixed_content(2,1):"fast"==t&&(yield*this._fast_fixed_content(2,1,2))}*_simple_fixed_content(t,e){if(t>this.N)this.N%e==0&&(yield[...this.word]);else for(let i=this.word[t-e-1];i<this.k;i++)this.occurrence[i]>0&&(this.word[t-1]=i,this.occurrence[i]-=1,i==this.word[t-e-1]?yield*this._simple_fixed_content(t+1,e):yield*this._simple_fixed_content(t+1,t),this.occurrence[i]+=1)}*_fast_fixed_content(t,e,i){let s;if(this.occurrence[this.last_letter]==this.N-t+1)this.occurrence[this.last_letter]==this.run[t-e-1]?this.N%e==0&&(yield[...this.word]):this.occurrence[this.last_letter]>this.run[t-e-1]&&(yield[...this.word]);else if(this.occurrence[this.first_letter]!=this.N-t+1){let r=Math.max.apply(Math,this.alphabet),n=this.alphabet.length-1,h=i;for(;r>=this.word[t-e-1];)this.run[parseInt(i-1)]=parseInt(t-i),this.word[t-1]=r,this.occurrence[r]-=1,this.occurrence[r]||(s=this.__remove_letter(r)),r!=this.last_letter&&(h=t+1),r==this.word[t-e-1]?yield*this._fast_fixed_content(t+1,e,h):yield*this._fast_fixed_content(t+1,t,h),this.occurrence[r]||this.__add_letter(s,r),this.occurrence[r]+=1,n-=1,r=this.__get_letter(n);this.word[t-1]=this.last_letter}}__remove_letter(t){let e=this.alphabet.indexOf(t);return this.alphabet.splice(e,1),e}__add_letter(t,e){this.alphabet.splice(t,0,e)}__get_letter(t){return t<0?-1:this.alphabet[t]}}const o=(t,e)=>{if(e>t.length||e<=0)return[];if(e==t.length)return[t];if(1==e)return t.reduce(((t,e)=>[...t,[e]]),[]);let i=[],s=[];for(let r=0;r<=t.length-e+1;r++){s=o(t.slice(r+1),e-1);for(let e=0;e<s.length;e++)i.push([t[r],...s[e]])}return i};class l{constructor(t=12){this.edo=t,this.cents_per_step=12/t*100,this.M3s=this.convert.ratio_to_interval(5/4,20),this.m3s=this.convert.ratio_to_interval(1.2,20),this.P5s=this.convert.ratio_to_interval(1.5,5),this.edo_divisors=this.get.divisors(t),this.catalog={}}scale(t){return new a(t,this)}make_DOM_svg(t,e,i,s=!1){let r=document.createElement("div");r.style.width=e+"px",r.style.height=i+"px",r.style.display="inline";let n=r.setAttribute("id","paper_"+Date.now()),h=document.getElementById(t);s&&(h.innerHTML=""),h.appendChild(r);const o=new Raphael(r,e,i);let l=o.rect(0,0,e,i).attr("fill","#000000");return{div_id:n,div:r,container_id:t,container:h,paper:o,background:l,width:e,height:i,cleaned:s}}shuffle_array(t,e=!0){let i;i=e?t:[...t];for(let t=i.length-1;t>0;t--){const e=Math.floor(Math.random()*t),s=i[t];i[t]=i[e],i[e]=s}return i}sort_scales=t=>t=t.sort(((t,e)=>{let i=Math.min(t.pitches.length,e.pitches.length);for(let s=0;s<i;s++){if(t.pitches[s]!=e.pitches[s])return t.pitches[s]-e.pitches[s];if(t.pitches[s]==e.pitches[s]&&s==i-1)return t.pitches.length-e.pitches.length}}));convert={cents_to_ratio:t=>Array.isArray(t)?t.map((t=>this.convert.cents_to_ratio(t))):Math.pow(2,t/1200),cents_to_simple_ratio:(t,e=17)=>{if(Array.isArray(t))return t.map((t=>this.convert.cents_to_simple_ratio(t,e)));if(0==(t=this.mod(t,1200)))return{cents:0,cents_in_octave:0,value:1,diff_in_octave:0,ratio:"1/1",original:0};let i,s=this.get.simple_ratios(e,!0);for(let e of Object.keys(s))if(i){Math.abs(s[e].cents_in_octave-t)<Math.abs(s[i].cents_in_octave-t)&&(i=e)}else i=e;return s[i].diff_in_octave=t-s[i].cents_in_octave,s[i].ratio=i,s[i].original=t,s[i]},interval_to_cents:t=>this.cents_per_step*t,interval_to_ratio:t=>Array.isArray(t)?t.map((t=>this.convert.interval_to_ratio(t))):Math.pow(2,t/this.edo),intervals_to_pitches:(t,e=0,i)=>{let s;s=i?[mod(e,i)]:[e];for(let r of t)if(Array.isArray(r)){e=s.flat()[s.flat().length-1];let t=this.convert.intervals_to_pitches(r,e);t=t.slice(1),s.push(t)}else i?s.push(mod(parseInt(s[s.length-1])+parseInt(r)),i):s.push(parseInt(s[s.length-1])+parseInt(r));return s},intervals_to_scale:t=>{let e=[0];return t.forEach((t=>{e.push(t+e[e.length-1])})),this.scale(e).pitches},midi_to_intervals:t=>{let e=[];for(let i=0;i<t.length-1;i++)e.push(t[i+1]-t[i]);return e},midi_to_name:(t,e=0)=>{if(12!=this.edo)return t;if(Array.isArray(t))return t.map((t=>this.convert.midi_to_name(t,e)));{t+=e;let i=Math.floor(t/12)-1;return this.convert.pc_to_name(this.mod(t,12)).trim()+i}},midi_to_freq:(t,e=0,i=440)=>Array.isArray(t)?t.map((t=>this.convert.midi_to_freq(t,e,i))):Math.pow(2,(t+e-69)/12)*i,name_to_scale:t=>{let e=(t=t.split("-"))[0];if(t=t[1],e!=this.edo)return"Wrong edo";let i=[];for(let s=e;s>0;s--){let e=Math.pow(2,s);e>t||(i.push(s),t-=e)}return i.push(0),i.reverse(),this.scale(i)},pc_to_name:t=>12!=this.edo?t:Array.isArray(t)?t.map((t=>this.convert.pc_to_name(t))):{0:"C ",1:"C#",2:"D ",3:"Eb",4:"E ",5:"F ",6:"F#",7:"G ",8:"Ab",9:"A ",10:"Bb",11:"B ","*":"**"}[t].trim(),pitches_to_PCs:t=>t.map((t=>this.mod(t,this.edo))),ratio_to_cents:t=>1200*Math.log2(t),ratio_to_interval:(t,e=10)=>{let i=[],s=this.convert.ratio_to_cents(t);for(let t=0;t<this.edo;t++){let r=this.convert.interval_to_cents(t);if(Math.abs(r-s)<=e)i.push(t);else if(i.length>0)break}return i},to_steps:(t,e=!1)=>{if(this.catalog[String(t)]||(this.catalog[String(t)]={}),this.catalog[String(t)].steps)return this.catalog[String(t)].steps;let i=[...t],s=[];for(let t=0;t<i.length-1;t++)s.push(i[t+1]-i[t]);return e&&(this.catalog[String(t)].steps=s),s}};count={common_tones:(t,e)=>t.reduce(((t,i)=>t+e.includes(i)),0),differences:(...t)=>{let e=t.map(((t,e,i)=>{if(e!=i.length-1){let t=i[e].length,s=i[e+1].length,r=Math.min(t,s),n=Math.max(t,s)-r;for(let t=0;t<r;t++)i[e][t]!=i[e+1][t]&&n++;return n}}));return e.slice(0,e.length-1)},pitches:t=>{let e=[],i=new Set(t);for(let s of i){let i=t.reduce(((t,e)=>e==s?t+1:t),0);e.push([s,i])}return e.sort(((t,e)=>e[1]-t[1])),e}};export={png:e=>{if("server"==t)return console.log("This is only support when run on client-side");const i=function(t){let i=new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}),s=document.createElement("a");s.setAttribute("download",e+".png"),s.setAttribute("href",t),s.setAttribute("target","_blank"),s.dispatchEvent(i)};let s=document.getElementById(e).getElementsByTagName("svg");for(let t of s){let e=t.getBBox(),s=e.width,r=e.height,n=document.createElement("canvas");n.width=s,n.height=r;let h=n.getContext("2d"),o=(new XMLSerializer).serializeToString(t),l=window.URL||window.webkitURL||window,a=new Image,c=new Blob([o],{type:"image/svg+xml;charset=utf-8"}),p=l.createObjectURL(c);a.onload=function(){h.drawImage(a,0,0),l.revokeObjectURL(p);var t=n.toDataURL("image/png").replace("image/png","image/octet-stream");i(t)},a.src=p}},svg:e=>{if("server"==t)return console.log("This is only support when run on client-side");let i=document.getElementById(e).getElementsByTagName("svg");for(let t of i){let i='<?xml version="1.0" encoding="utf-8"?>'+t.outerHTML,s=document.createElement("a");s.download=e+".svg",s.type="image/svg+xml";let r=new Blob([i],{type:"image/svg+xml"});s.href=(window.URL||webkitURL).createObjectURL(r),s.click()}}};get={angle:t=>{let e=Math.abs(t[0]-t[1]);e=e>Math.ceil(this.edo/2)?this.edo-e:e;let i=Math.abs(t[1]-t[2]);return i=i>Math.ceil(this.edo/2)?this.edo-i:i,(180-e/12*360)/2+(180-i/12*360)/2},best_edo_from_cents:(t,e=t.length+2,i=24)=>{let s=t,r=1/0,n=1/0;for(let t=e;t<=i;t++){let e=new l(t).get.notes_from_cents(s).reduce(((t,e)=>t+Math.abs(e.diff)),0);e<r&&(r=e,n=t)}let h=new l(n);return h.scale(h.get.notes_from_cents(s).map((t=>t.note)))},coordinates:(t,e=[0,0],i=.56418958354776)=>{if(Array.isArray(t))return t.map((t=>this.get.coordinates(t,e,i)));const s=360/this.edo,r=(t=this.mod(t,this.edo))*s*(Math.PI/180);return[i*Math.sin(r)+e[0],i*Math.cos(r)+e[1]]},contour:(t,e=!1)=>{if(e){let e=[];for(let i=1;i<t.length;i++)t[i]>t[i-1]?e.push(1):t[i]==t[i-1]?e.push(0):e.push(-1);return e}{let e={},i=this.get.unique_elements(t);i=i.sort(((t,e)=>t-e));for(let t=0;t<i.length;t++)e[i[t]]=t;return t.map((t=>e[t]))}},contour_motives:(t,e=!1,i=8)=>{let s=[],r=this.get.subsets(t,e).map((t=>this.get.contour(t))).filter((t=>t.length>1));return r=r.filter((t=>t.length<=i)),s=this.get.unique_elements(r).map((t=>{let e=0;for(let i=0;i<r.length;i++)this.is.same(t,r[i])&&e++;return{motive:t,incidence:e}})),s=s.sort(((t,e)=>e.incidence-t.incidence||e.motive.length-t.motive.length)),s},combinations:(t,e)=>{let i=this.get.n_choose_k(t,e);return i=i.map((t=>this.get.permutations(t))),i=i.flat(),i=this.get.unique_elements(i),i},complementary_interval:t=>this.edo-t,complementary_set:(t,e)=>{let i=Array.from(Array(this.edo).keys());return t.forEach((t=>{-1==i.indexOf(t)||i.splice(i.indexOf(t),1)})),e&&(i=this.scale(i).pitches),i},harmonic_progression:(t,e,i=4,s=2)=>{let r=[e],n=100;for(;r.length<i&&n>0;){let e=r[r.length-1],i=[];for(let r of t)for(let t=0;t<this.edo;t++){let n=r.map((e=>(e+t)%this.edo)),h=this.count.common_tones(n,e);h>=s&&h!=e.length&&i.push(n)}i=this.get.unique_elements(i),0!=i.length?r.push(this.shuffle_array(i)[0]):n--}for(let t=1;t<r.length;t++)r[t]=this.get.minimal_voice_leading(r[t-1],r[t]);return r},harmonized_melody:(t,e,i,s=1)=>{let r=[],n=[...t],h=i;e=e.map((t=>this.scale(t).get.modes())).flat(),n=n.map(((t,i)=>{let n=e.map((e=>e.map((e=>(e+t)%this.edo)).sort(((t,e)=>t-e))));if(h&&0==i)return r.push(h),h;h&&(n=n.filter((t=>{let e=this.count.common_tones(t,h);return e>=s&&e!=h.length})));let o=this.shuffle_array(n)[0];return r.push(o),h=o,h}));for(let t=1;t<r.length;t++)null!=r[t]&&null!=r[t-1]&&(r[t]=this.get.minimal_voice_leading(r[t-1],r[t]));return console.log(r),r},harp_position_of_quality:(t,e=[0,2,4,5,7,9,11],i=[-1,0,1])=>{let s=[],r=e.map((t=>i.map((e=>this.mod(t+e,this.edo))))),n=this.get.partitioned_subsets(r);return n=n.map((r=>{for(let n=0;n<this.edo;n++){let h=t.map((t=>(t+n)%this.edo));if(this.is.subset(h,r)){let t=[],n=[],o=[];h.forEach((e=>t.push(r.indexOf(e)+1))),t.forEach((t=>{let s=-e[t-1]+r[t-1];i.includes(s)||(s<0?s=this.mod(s+this.edo,this.edo):s>0&&(s-=this.edo)),o.push(r[t-1]),n.push(s)})),s.push({strings:t,pedals:n,pitches:o})}}})),s=this.get.unique_elements(s),s=s.sort(((t,e)=>{let i=t.pitches,s=e.pitches,r=i.length;for(let t=0;t<r;t++)if(i[t]!=s[t])return i[t]-s[t]})),s},harp_pedals_to_pitches:(t,e=[0,2,4,5,7,9,11])=>e.map(((e,i)=>this.mod(e+t[i],this.edo))),harp_least_pedals_passage:(t,e=[0,2,4,5,7,9,11],i=[-1,0,1])=>{let s=e.map((t=>i.map((e=>this.mod(t+e,this.edo))))),r=this.get.partitioned_subsets(s),n=[],h=(t,i=[])=>{let s,o,l;for(let i=0;i<t.length;i++){s=t.slice(0,t.length-i),o=t.slice(t.length-i);let n=this.get.unique_elements(s.map((t=>this.mod(t,this.edo))));if(!(n.length>e.length)&&(l=r.filter((t=>this.is.subset(n,t))),l.length>0))break}l&&l.forEach((t=>{0==o.length?n.push([...i,t]):h(o,[...i,t])}))};h(t);let o=n.map((t=>t.map(((e,i)=>{if(i==t.length-1)return 0;let s=t[i],r=t[i+1],n=0;for(let t=0;t<r.length;t++)s[t]!=r[t]&&n++;return n})))).map((t=>t.reduce(((t,e)=>t+e),0))),l=Math.min(...o),a=[];return o.forEach(((t,e)=>{t==l&&a.push(e)})),n=n.filter(((t,e)=>a.includes(e))),{paths:n,pedals:l}},fill_partial_harp_pedaling:(t,e=[-1,-1,-1,-1,-1,-1,-1],i=[0,2,4,5,7,9,11])=>t=t.map((t=>{let i=[...e];return t.strings.forEach(((e,s)=>{i[e-1]=t.pedals[s]})),t.pedals=i,t})),interval_class:(t,e)=>{let i=Math.abs(t-e);return i<Math.ceil(this.edo/2)?i:this.edo-i},n_choose_k:(t,e=2)=>{let i=[];const s=(t,e,r=0,n=Array(e))=>{if(0!=e)for(let i=r;i<=t.length-e;i++)n[n.length-e]=t[i],s(t,e-1,i+1,n);else i.push([...n])};return s(t,e),i},notes_from_cents:(t=[])=>{let e=1200/this.edo;return t=t.map((t=>this.mod(t,1200))).map((t=>{let i=Math.floor(t/e),s=t-i*e,r=Math.ceil(t/e),n=r*e-t;return s<n?{note:i,diff:-s}:{note:r,diff:n}}))},sine_pair_dissonance:(t,e,i=1,s=1)=>{const r=Math.min(t,e),n=Math.max(t,e),h=Math.min(i,s),o=Math.max(i,s),l=h*o,a=2*h/(h+o),c=.24/(.0207*r+18.96),p=Math.pow(Math.E,-3.5*c*(n-r))-Math.pow(Math.E,-5.75*c*(n-r));return.5*Math.pow(l,.1)*Math.pow(a,3.11)*p},resize_melody:(t,e=2,i="multiply")=>{let s=t[0];return t=this.convert.to_steps(t),"add"==i?t=t.map((t=>t>0?t+e>0?t+e:0:t<0&&t-e<0?t-e:0)):"multiply"==i&&(t=t.map((t=>Math.round(t*e)))),t=this.convert.intervals_to_pitches(t),this.get.transposition(t,s,!1)},generated_scale:(t=7,e=7,i=!1)=>{let s=[];for(let i=0;i<e;i++)s.push(this.mod(t*i,this.edo));return s=this.get.normal_order(s.sort(((t,e)=>t-e))),s},generators:(t=!1)=>{let e=[];for(let t=1;t<Math.ceil(this.edo/2);t++){let i=Array.from(Array(this.edo).keys()).map((e=>this.mod(e*t,this.edo)));i=this.get.unique_elements(i),i.length==this.edo&&e.push(t)}return t&&(e=e.map((t=>[t,this.get.complementary_interval(t)]))),e},intersection:(...t)=>{let e=t[0];for(let i=1;i<t.length;i++)e=e.filter((e=>t[i].includes(e)));return e},interval_traversed:t=>t.reduce(((t,e)=>t+e)),interval_stack:(t,e=3,i=!1)=>{const s=(t,e)=>{if(0==t)return[0];let i=[];for(;t;)i.push(t%e),t=Math.floor(t/e);return i.reverse(),i};let r=[],n=(t=this.get.unique_elements(t)).length,h={},o=[];for(let e=0;e<t.length;e++)h[e]=t[e];let l=n**e;for(let t=0;t<l;t++){let i=s(t,n),h=e-i.length;h=Array(h).fill(0),r.push([...h,...i])}for(let t of r)o.push(t.map((t=>h[t])));if(o.sort(((t,e)=>t.reduce(((t,e)=>t+e))-e.reduce(((t,e)=>t+e)))),i){let t=[];for(let e of o){let i=[0];for(let t of e)i.push(i[i.length-1]+t);t.push(i)}o=t}return o},inversion:(t,e=!1)=>{if(this.catalog[String(t)]||(this.catalog[String(t)]={}),this.catalog[String(t)].inverted)return this.catalog[String(t)].inverted;let i=[...this.convert.to_steps(t)];i.reverse();let s=this.convert.intervals_to_scale(i);return e&&(this.catalog[String(t)].inverted=s),s},lattice:(t=3,e=4,i=!1)=>{let s="";for(let r=this.edo;r>=-this.edo;r-=e){let e="";for(let s=0;s<this.edo;s++){let n,h=this.mod(r+s*t,this.edo);n=i?this.convert.pc_to_name(h):String(h),e+=n+" ".repeat(3-n.length)}s+=e+"\n\n"}return s},levenshtein:(t,e,i=!1)=>{let s,r,n=t,h=e,o=n.length+1,l=h.length+1,a=Array.from({length:o},(t=>Array(l).fill(0)));for(let t=1;t<o;t++)for(let e=1;e<l;e++)a[t][0]=t,a[0][e]=e;let c=0;for(s=1;s<l;s++)for(r=1;r<o;r++){c=n[r-1]==h[s-1]?0:i?2:1;let t=Math.min.apply(Math,[a[r-1][s]+1,a[r][s-1]+1,a[r-1][s-1]+c]);a[r][s]=t}if(i){return(n.length+h.length-a[r-1][s-1])/(n.length+h.length)}return a[n.length][h.length]},maximal_rahn_difference:t=>t*(t-1)*(t-1)/2,maximal_carey_coherence_failures:t=>t*(t-1)*(t-2)*(3*t-5)/24,minimal_voice_leading:(t,e)=>{let i=this.get.permutations(e),s=i.map((e=>e=e.map(((i,s)=>{let r=Math.abs(e[s]-t[s]);return r=r>Math.ceil(this.edo/2)?this.edo-r:r,r})).reduce(((t,e)=>t+e),0))),r=s.reduce(((t,e)=>e<t?e:t),1/0);return i[s.indexOf(r)]},modes:(t,e=!1,i=!0)=>{if(this.edo,this.catalog[String(t)]||(this.catalog[String(t)]={}),this.catalog[String(t)].modes)return this.catalog[String(t)].modes;let s=t.length,r=t.concat(t),n=[];for(let t=0;t<s;t++){let e=this.edo-r[t],i=r.slice(t,t+s);i=i.map((t=>(t+e)%this.edo)),n.push(i)}return i&&(n=this.get.unique_elements(n)),e&&(this.catalog[String(t)].modes=n),n},motives:(t,e=!0,i=!1,s=8)=>{let r=[];if(e){let e=this.get.subsets(t,i).filter((t=>t.length<=s)).map((t=>this.convert.to_steps(t))),n=this.get.unique_elements(e);r=n.map((t=>{let i=0;for(let s=0;s<e.length;s++)this.is.same(t,e[s])&&i++;return{motive:t,incidence:i}}))}else{this.get.unique_elements(this.get.subsets(t,i).filter((t=>t.length<=s))).forEach((e=>{let s=this.get.subset_indices(e,t,i).length;r.push({motive:e,incidence:s})}))}return r=r.filter((t=>t.motive.length>0)),r=r.sort(((t,e)=>e.incidence-t.incidence||e.motive.length-t.motive.length)),r},necklace:t=>{let e=[],i=this.get.unique_elements(t),s={},r=[];i.forEach(((e,i)=>{s[i]=e;let n=t.reduce(((t,i)=>i==e?t+1:t),0);r.push(n)}));let n=new h(r);return Array.from(n.execute("fast")).forEach((t=>{let i=t.map((t=>s[t]));e.push(i)})),e},new_pitches:(t,e=!0)=>{let i=[],s=[];for(let r=0;r<t.length;r++)if(e){if(-1==s.indexOf(this.mod(t[r],this.edo))&&(s.push(t[r]),i.push([t[r],r]),s.length==this.edo))break}else-1==s.indexOf(t[r])&&(s.push(t[r]),i.push([t[r],r]));return i},ngrams:(t,e=3)=>{let i={};for(;e>1;e--)for(let s=0;s<t.length-(e-1);s++){let r=[];for(let i=s;i<s+(e-1);i++)r.push(t[i]);r=r.join(" "),Array.isArray(i[r])?i[r].push(t[s+(e-1)]):i[r]=[t[s+(e-1)]]}return i},normal_order:(t,e=!1)=>{if(0==t.length)return[];let i=this.edo;if(this.catalog[String(t)]||(this.catalog[String(t)]={}),this.catalog[String(t)].normal_order)return this.catalog[String(t)].normal_order;let s=[];t.forEach((t=>{s.push(t%this.edo)})),s=this.get.unique_elements(s),s.sort(((t,e)=>t-e));let r=this.get.modes(s),n=function(t){let e=i,s=[];if(t.forEach((t=>{t[t.length-1]<e&&(e=t[t.length-1])})),t.forEach((t=>{t[t.length-1]==e&&s.push(t)})),1==s.length)return s[0];{let t=s[0][s[0].length-1],e=s.map((t=>t.slice(0,-1))),i=n(e);return i.push(t),i}},h=n(r);return e&&(this.catalog[String(t)].normal_order=h),h},stacked:(t,e,i=!1)=>{let s=this.get.permutations(t),r=[];for(let t=0;t<s.length;t++){let n=s[t];for(let t=0;t<n.length;t++){let i=1;for(;n[t]<n[t-1];)n.splice(t,1,n[t]+this.edo*i),i++;-1!=e.indexOf(n[t]-n[t-1])||0==t||(n=!1)}n&&(i?r.push(this.get.transposition(n,-1*n[0],!1)):r.push(n))}return r},without:(t,e,i=!1)=>{let s=[...t];return e.forEach((t=>{do{var e=s.indexOf(t);-1!=e&&s.splice(e,1)}while(-1!=e)})),i&&(s=this.get.normal_order(s)),s},partitioned_subsets:t=>{t=t.map((t=>Array.isArray(t)?t:[t]));let e=[];const i=function(t){for(let s=0;s<t.length;s++){if(t[s].length>1){t[s].forEach((r=>{if(s<t.length-1){let e=[...t.slice(0,s),[r],...t.slice(s+1)];i(e)}else e.push([...t.slice(0,s),[r]])}));break}s==t.length-1&&e.push(t)}};return i(t),e=e.map((t=>t.map((t=>t[0])))),e},path_n_steps:(t,e=[],i=8)=>{const s=e.filter((t=>this.get.interval_traversed(t)>0)),r=e.filter((t=>this.get.interval_traversed(t)<0)),n=e.filter((t=>0==this.get.interval_traversed(t)));let h=[];const o=function(e=[]){let l=e.flat().reduce(((t,e)=>t+e),0),a=e.flat().length;if(a>i||a==i&&l!=t)return null;if(a==i&&l==t)return e;if(l<t)for(let t=0;t<s.length;t++){let i=o(e.concat([s[t]]));null!=i&&h.push(i)}else if(l>t)for(let t=0;t<r.length;t++){let i=o(e.concat([r[t]]));null!=i&&h.push(i)}for(let t=0;t<n.length;t++){let i=o(e.concat([n[t]]));null!=i&&h.push(i)}};return o(),this.get.unique_elements(h)},path_on_tree:(t,e,i=0)=>{let s=[i];for(let i of e)s.push(s[s.length-1]+t[i]);return s},permutations:t=>{let e=[];const i=(t,s=[])=>{if(0===t.length)e.push(s);else for(let e=0;e<t.length;e++){let r=t.slice(),n=r.splice(e,1);i(r.slice(),s.concat(n))}};return i(t),e},pitch_distribution:(t,e=!1)=>{e&&(t=t.map((t=>this.mod(t,this.edo))));let i=this.get.unique_elements(t).map((e=>({note:e,rate:t.filter((t=>t==e)).length/t.length})));return i=i.sort(((t,e)=>e.rate-t.rate)),i},pitch_fields:(t,e=8,i=!0,s=!1,r=!1)=>{if(s){let s=[];for(let n=0;n<t.length-e;n++){let h=[i?this.mod(t[n],this.edo):t[n]];t:for(let s=n+1;s<t.length&&h.length!=e;s++){let e;e=i?this.mod(t[s],this.edo):t[s],-1==h.indexOf(e)&&h.push(e)}h=h.sort(((t,e)=>t-e)),r&&this.is.same(s[s.length-1],h)||s.push(h)}return s}{let s=[];for(let i=0;i<=t.length-e;i++)s.push(t.slice(i,i+e));return s=s.map((t=>(i&&(t=t.map((t=>this.mod(t,this.edo)))),t=this.get.unique_elements(t).sort(((t,e)=>t-e))))).filter(((t,e,i)=>e+1==i.length||!this.is.same(i[e],i[e+1]))),s}},random_melody:(t=8,e=[0,12],i=4,s,r=5)=>{let n=0,h=[],o=[];for(let t=e[0];t<=e[1];t++)s&&-1==s.indexOf(this.mod(t,this.edo))||o.push(t);for(;h.length<t&&n<1e3;){n++;let t=h.slice(Math.max(h.length-i,0),h.length),e=o.filter((e=>-1==t.indexOf(e)));if(h.length>0){let t=[];do{t=e.filter((t=>Math.abs(t-h[h.length-1])<=r)),r++}while(0==t.length);e=t}let s=Math.floor(Math.random()*e.length);h.push(e[s])}return h},random_melody_from_contour:(t,e=[0,12],i)=>{let s=[],r=[],n=this.get.unique_elements([...t]).sort(((t,e)=>t-e)),h=n.length-r.length;for(let t=e[0];t<=e[1];t++)i?-1!=i.indexOf(this.mod(t,this.edo))&&s.push(t):s.push(t);for(;r.length<h;){let t=Math.floor(Math.random()*s.length),e=s.splice(t,1)[0];r.push(e),h=n.length}r=r.sort(((t,e)=>t-e));let o={};for(let t=0;t<n.length;t++)o[n[t]]=r[t];return t=t.map((t=>o[t]))},random_melody_from_ngram:(t,e=[0],i=16)=>{let s=[...e],r=100+i;for(;s.length<i&r>0;){t:for(let e=s.length;e>0;e--){let i=t[s.slice(s.length-e).join(" ")];if(Array.isArray(i)){let t=i[Math.floor(Math.random()*i.length)];s.push(t);break t}}r--}return s},random_melody_from_distribution:(t,e=8)=>{let i=[];t=t.sort(((t,e)=>t.rate-e.rate));let s=Math.floor(1/t[0].rate);for(t=(t=t.map((t=>[...new Array(Math.ceil(s*t.rate)).fill(t.note)]))).flat();i.length<e;){let e=Math.floor(Math.random()*t.length);i.push(t[e])}return i},ratio_approximation:(t,e=17)=>{let i=0,s="",r=0,n=this.convert.interval_to_cents(t),h=this.get.simple_ratios(e=e);for(let t in h){Math.abs(h[t].cents-n)<Math.abs(n-i)&&(i=h[t].cents,s=t,r=h[t].value)}let o=s.split(":");o[0];let l=o[1];return{ratio:s,cents_offset:n-i,decimal:r,octave:Math.log2(parseInt(l)),log_position:Math.log2(r)}},retrograde:t=>t.reverse(),rotated:(t,e)=>(e=this.mod(e,t.length),[...t.slice(e),...t].slice(0,t.length)),rotations:t=>{let e=[];for(let i=0;i<t.length;i++)e.push([...t.slice(i,t.length),...t.slice(0,i)]);return e},scalar_melodies:(t,e=[1,2],i=!0)=>{e.push(0);let s=[];return t.forEach(((t,r)=>{let n=!1;for(let i=0;i<s.length;i++){let h=s[i],o=h[h.length-1].pitch,l=Math.abs(t-o);this.is.element_of(l,e)&&(s[i].push({pitch:t,index:r}),n=!0)}if(!n){let n=[];if(i){let i=[];e.forEach((e=>{i.push(t+e),i.push(t-e)})),i=this.get.unique_elements(i),i.forEach((e=>{s.map((t=>t.map((t=>t.pitch)))).forEach(((i,s)=>{if(i.includes(e)){let h=i.lastIndexOf(e);n.push([t,r,s,h])}}))})),n=n.map((t=>{let e=s[t[2]].slice(0,t[3]+1);return e=[...e,{pitch:t[0],index:t[1]}],e})),s=[...s,...n]}0==n.length&&s.push([{pitch:t,index:r}])}})),s},scales:(t=1,e=this.edo-1,i=1,s=this.edo,r=this.edo,n=this)=>{const h=(t,e)=>{let i=[];for(let s=0;s<e.length;s++){let r=e[s],n=Math.floor(t/r);t/r==n&&1==e.length&&i.push(Array(n).fill(r));let o=[...e];if(o.splice(s,1),o.length>0)for(let e=n;0!=e;e--){let s=t-e*r;if(s>0){let t=h(s,o);if(t.length>0)for(let s=0;s<t.length;s++){let n=Array(e).fill(r).concat(t[s].flat());n.sort(((t,e)=>t-e)),i.push(n)}}}}return this.get.unique_elements(i)};let l=function(t,e){let i=[];for(let s=e;s!=t-1;s--)i.push(s);return i}(t,e),c=function(t,e,i){let s=[];for(let r=t;r<=e;r++)s=s.concat(o(i,r));return s}(i,s,l),p=function(t){let e=[];return t.forEach((t=>{let i=h(n.edo,t);i.length>0&&(e=e.concat(i))})),e}(c).filter((t=>t.length<=r)),u=function(t){let e=[];for(let i=0;i<t.length;i++){let s=t[i],r=n.get.necklace(s);e=e.concat(r)}return e}(p),g=(t=>{let e=[];return t.forEach((t=>{e.push(n.convert.intervals_to_scale(t))})),e})(u),f=[];return g.forEach((t=>f.push(new a(t,this).normal()))),f=this.sort_scales(f),f},shortest_path:(t,e=[5,-3],i=[],s=10)=>{let r=[],n=[];for(let t of e)t>0?r.push(t):t<0&&n.push(t);let h=[];const o=function(t,e=[3,4],i=[-1,-2],s=[],r=10){if(r<0)return null;let n=s.reduce(((t,e)=>t+e),0);if(n==t&&(0==h.length||h.length>s.length))h=[...s];else if(n!=t||!(0!=h.length||h.length<=s.length))if(n<t)for(let n of e)o(t,e,i,s.concat([n]),r-1);else if(n>t)for(let n of i)o(t,e,i,s.concat([n]),r-1)};return o(t,r,n,i,s),h=h.sort(((t,e)=>t-e)),h},simple_ratios:(t=17,e=!1)=>{let i=this.get.primes_in_range(t),s={};for(let e=2;e<t+1;e++)for(let t=1;t<e;t++)i.indexOf(e)<0&&i.indexOf(t)<0||e%2==0&&t%2==0||e%t==0&&t>2||(s[String(e)+":"+String(t)]={cents:this.convert.ratio_to_cents(e/t),cents_in_octave:this.mod(this.convert.ratio_to_cents(e/t),1200),value:e/t});return s},starting_at:(t,e=0,i=!0)=>{let s=-1*t[0]+e;return t.map((t=>i?this.mod(t+s,this.edo):t+s))},subset_indices:(t,e,i=!0)=>{let s=[];const r=function(t,e,i=[],n=0){if(0==t.length)return i;let h=t[0];for(let o=n;o<e.length;o++)if(e[o]==h){let n=r(t.slice(1),e,[...i,o],o+1);n&&s.push(n)}};return i?r(t,e):function(t,e){t:for(let i=0;i<e.length-(t.length-1);i++)for(let r=0;r<t.length;r++){if(t[r]!=e[i+r])continue t;if(r==t.length-1){let e=new Array(t.length).fill(0);e.forEach(((t,s)=>e[s]=i+s)),s.push(e)}}}(t,e),s},subsets:(t,e=!0,i=!1)=>{if(e)t=t.reduce(((t,e)=>t.concat(t.map((t=>[...t,e])))),[[]]);else{let e=[];for(let i=1;i<t.length+1;i++)for(let s=0;s<t.length-i+1;s++)e.push(t.slice(s,s+i));t=e}return t=t.filter((t=>t.length>0)),i&&(t=t.map((t=>this.get.normal_order(t))),t=this.get.unique_elements(t)),t},transposition:(t,e=0,i=!0)=>(t=t.map((t=>t+e)),i&&(t=t.map((t=>this.mod(t,this.edo)))),t),union:(...t)=>[].concat(...t),unique_elements:t=>{let e=new Set(t.map(JSON.stringify));return e=Array.from(e).map(JSON.parse),e},well_formed_scale:(t=7)=>[...Array(t).keys()].map((e=>Math.floor(e*this.edo/t))),without_chromatic_notes:t=>t=t.filter(((t,e,i)=>{let s=0;return e>0&&(i[e-1]>i[e]?s=-1:i[e-1]<i[e]&&(s=1)),i[e]+s!=i[e+1]})),primes_in_range:(t=17,e=2)=>{let i=[];for(let s=e;s<=t;s++)if(s>1)for(let t=2;t<s&&s%t!=0;t++)i.push(s);return i},divisors:t=>{let e=[];for(let i=2;i<Math.ceil(t/2);i++)t%parseInt(i)==0&&e.push(i);return e}};midi={import:e=>{if("server"!=t)return alert("This is currently supported only on server-side");let i=n(e);return i=s.parse(i),i.track=i.track.map((t=>(t.event=t.event.map(((t,e,i)=>(t.onset=0==e?t.deltaTime:i[e-1].onset+t.deltaTime,t))),t))),i},strip:t=>{let e=t,i=[];e.track=e.track.map((t=>(t.event=t.event.filter((t=>9==t.type)).map((t=>({pitch:t.data[0],onset:t.onset}))).map(((t,e,s)=>{let r=t.onset;return-1==i.indexOf(r)&&i.push(r),s.filter((t=>t.onset==r))})),t.event=this.get.unique_elements(t.event),t))),i.sort(((t,e)=>t-e)),e.track=e.track.map((t=>(t.event=t.event.map((t=>t=t.map((t=>(t.onset=i.indexOf(t.onset),t))))),t))),e.track=e.track.map((t=>t=t.event.reduce(((t,e)=>(e.forEach((e=>{null==t[e.onset]?t[e.onset]=[e.pitch]:t[e.onset].push(e.pitch)})),t)),[]))),e.track=e.track.filter((t=>t.length>0));let s=[];return e.track.forEach((t=>{t.forEach(((t,e)=>{null==s[e]?s[e]=[...t]:s[e]=[...s[e],...t]}))})),s=s.map((t=>1==t.length?t[0]:t)),s},chordify:(t,e=480,i=!0,s=!1,r=!1)=>{let n=t,h=0;return n=n.track.map((t=>(t.event=t.event.filter((t=>9==t.type)),t.event.map((t=>h=t.onset>h?t.onset:h)),[...t.event]))).flat().sort(((t,e)=>t.onset-e.onset)),Array.from(Array(Math.ceil(h/e)).keys()).map((t=>t*e)).map(((t,e,i)=>i.length-1>e?n.filter((t=>t.onset>=i[e]&&t.onset<i[e+1])):n.filter((t=>t.onset>=i[e])))).map((t=>(t=t.map((t=>s?this.mod(t.data[0],this.edo):t.data[0])),r&&t.sort(((t,e)=>t-e)),i&&(t=this.get.unique_elements(t)),t)))}};xml={import:e=>{if("server"!=t)return alert("This is currently supported only on server-side");var s=n(e);let r;return i(s,(function(t,e){r=e})),r}};is={element_of:(t,e)=>{if(0==t.length||0==e.length)return!1;return t=JSON.stringify(t),-1!=JSON.stringify(e).indexOf(t)},rotation:(t,e)=>{let i=[...e,...e];for(let s=0;s<e.length;s++)if(this.is.same(t,i.slice(s,s+e.length)))return!0;return!1},same:(t,e)=>(t=JSON.stringify(t))==(e=JSON.stringify(e)),subset:(t,e)=>{for(let i of t)if(!e.includes(i))return!1;return!0},transposition:(t,e)=>{let i=t,s=e;return this.is.same(i,s.map((t=>this.mod(t-s[0]-i[0],this.edo))))}};show={contour:(t,e,i=!1,s)=>{let r,n,h=document.getElementById(t);s?Array.isArray(s)?(r=s[0],n=s[1]):(r=s,n=s):(r=h.offsetWidth,n=h.offsetHeight);let o=document.createElement("div");o.style.width=r+"px",o.style.height=n+"px",o.style.display="inline",o.setAttribute("id","paper_"+Date.now()),i&&(h.innerHTML=""),h.appendChild(o);const l=new Raphael(o,r,n);l.rect(0,0,r,n).attr("fill","000").attr("stroke","white");let a=Math.max.apply(Math,e),c=Math.min.apply(Math,e),p=15,u=e.map((t=>{return Math.floor((t-(e=c))*(p-(i=n-p))/(a-e)+i);var e,i})),g=p,f=Math.floor((r-30)/(e.length-1)),d="M15,"+u[0],m=l.set(),_=n/45;m.push(l.circle(p,u[0],_));for(let t=1;t<u.length;t++)g+=f,d+="L"+g+","+u[t],m.push(l.circle(g,u[t],_));l.path(d).attr("stroke","red").attr("stroke-width",2),m.attr("fill","white"),m.toFront()},interval_fractal_tree:(t,e=200,i=90,s=[0,2,4,5,7,9,11],r=[-1,1],n=5,h=.7)=>{const o=this,l=document.getElementById(t);l.innerHTML="";const a=this.edo;let c=l.offsetWidth,p=l.offsetWidth;const u=new Raphael(l,c,p),g=function(t=[0,0],e=50,i=90){return i=i*Math.PI/180,[Math.floor(t[0]+e*Math.cos(i)),Math.floor(t[1]+e*Math.sin(i))]};class f{constructor(t=300,e=0,i=0,s=0,r=20,n=90,h=.7,o=5,l=[-1,1],a=0,c=null){this.diatonic=!!c,this.mode=c,this.iterations=o,this.length_mul=h,this.angle_span=n,this.length=t,this.angle=e,this.circle_r=r,this.circle_o=g([i,s],t-r,e-90),this.start=[i,s],this.line_center=g(this.start,(this.length-2*this.circle_r)/2,this.angle-90),this.line_end=g(this.start,this.length-2*this.circle_r,this.angle-90),this.end=g([i,s],t,e-90),this.sub_branches=l.length,this.intervals=l,this.starting_pitch=a}draw_branch(){let t=this.start,e=this.line_end;u.path("M"+t.join(",")+"L"+e.join(",")).attr("stroke","white");let i=this.circle_o,s=Math.floor((this.starting_pitch-(r=0))*(360-(n=0))/(a-1-r)+n);var r,n;let h=Raphael.hsl2rgb(s,100,50);if(u.circle(i[0],i[1],this.circle_r).attr("fill",h),this.text=u.text(i[0],i[1],this.starting_pitch).attr("fill","blue").attr("font-size",25),this.iterations>0){let t=Math.floor(this.angle_span/2)-this.angle_span,e=this.angle_span/(this.sub_branches-1),i=this.length*this.length_mul;for(let s=0;s<this.sub_branches;s++){let r=100;if(this.diatonic){let t=this.mode.indexOf(this.starting_pitch);r=this.mode[o.mod(t+this.intervals[s],this.mode.length)]}else r=mod(this.starting_pitch+this.intervals[s],a);let n=this.angle+t+s*e,h=this.end[0],l=this.end[1];new f(i,n,h,l,this.circle_r,this.angle_span,this.length_mul,this.iterations-1,this.intervals,r,this.mode).draw_branch()}}}}u.clear(),u.rect(0,0,c,p).attr("fill","000"),new f(e=e,0,Math.floor(c/2),p,20,i,h,n,r,0,s).draw_branch()},necklace:t=>{t.cx=t.cx||t.paper.width/2,t.cy=t.cy||t.paper.height/2,t.radius=t.radius||t.paper.width/2-30,t.ring=null==t.ring||t.ring,t.inner_strings=null==t.inner_strings||t.inner_strings,t.outer_strings=null==t.outer_strings||t.outer_strings,t.PC_at_midnight=t.PC_at_midnight||0,t.string_width=t.string_width||1,t.node_color=t.node_color||"black",t.node_radius=t.node_radius||t.paper.height*Math.PI/(4*this.edo)/2-5;class e{constructor(t,e,i,s,r){this.necklace=t,this.radius=e,this.cx=i,this.cy=s,this.name=r}draw(){let t=this.necklace.paper;this.drawing&&(this.drawing.remove(),this.drawing=void 0),this.drawing=t.set(),this.circle=t.circle(this.cx,this.cy,this.radius).attr("stroke","white").attr("fill",this.necklace.node_color),this.drawing.push(this.circle),this.text=t.text(this.cx,this.cy,this.name).attr("fill","white").attr("font-size",this.radius),this.drawing.push(this.text)}}class i{constructor(t,e,i,s,r,n){this.necklace=t,this.x1=e,this.y1=i,this.x2=s,this.y2=r,this.length=Math.sqrt((s-e)**2+(r-i)**2),this.stroke_width=n}draw(){let t=this.necklace.paper;this.drawing&&(this.drawing.remove(),this.drawing=void 0);let e=Math.floor((i=this.length,s=0,r=2*this.necklace.radius,(i-s)*(360-(n=0))/(r-s)+n));var i,s,r,n;let h=Raphael.hsl2rgb(e,100,50);this.drawing=t.path("M"+this.x1+","+this.y1+"L"+this.x2+","+this.y2).attr("stroke",h.hex).attr("stroke-width",this.stroke_width)}}let s=new class{constructor(t,e){this.cx=e.cx,this.cy=e.cy,this.radius=e.radius,this.pitches=e.pitches,this.PC_at_midnight=e.PC_at_midnight,this.show_ring=e.ring,this.show_inner_strings=e.inner_strings,this.show_outer_strings=e.outer_strings,this.parent=t,this.edo=t.edo,this.nodes=[],this.strings=[],this.paper=e.paper,this.node_color=e.node_color,this.node_radius=e.node_radius,this.string_width=e.string_width,this.draw_all()}draw_all(){this.show_ring&&this.draw_ring(),this.draw_nodes(),this.draw_strings(this.string_width);for(let t of this.nodes)t.drawing.toFront(),t.text.toFront()}draw_ring(t="white",e=3){let i=this.paper;this.ring&&(this.ring.remove(),this.ring=void 0),this.ring=i.circle(this.cx,this.cy,this.radius).attr("stroke",t).attr("stroke-width",e)}draw_nodes(){for(let t of this.nodes)t.drawing.remove(),t.text.remove();this.nodes=[];let t=this.node_radius;t=Math.max(t,1);for(let i of this.pitches){let s=(i*(360/this.edo)-90)*Math.PI/180,r=Math.floor(this.cx+this.radius*Math.cos(s)),n=Math.floor(this.cy+this.radius*Math.sin(s)),h=new e(this,t,r,n,(i+this.PC_at_midnight)%this.edo);this.nodes.push(h)}for(let t of this.nodes)t.draw()}draw_strings(t){for(let t of this.strings)t.drawing.remove();if(this.strings=[],this.show_outer_strings)for(let e=0;e<this.nodes.length;e++){let s=this.nodes[e],r=this.nodes[(e+1)%this.nodes.length],n=new i(this,s.cx,s.cy,r.cx,r.cy,t);this.strings.push(n)}if(this.show_inner_strings)for(let e=0;e<this.nodes.length-2;e++)for(let s=2;s<this.nodes.length;s++){let r=this.nodes[e],n=this.nodes[s],h=new i(this,r.cx,r.cy,n.cx,n.cy,t);this.strings.push(h)}for(let t of this.strings)t.draw()}}(this,t);return s},nested_necklaces:(t,e,i=!0,s=600,r=!1,n,h=!0)=>{let o=s,l=s,a=o/2-o/20,c=e.length,p=Math.min(a/c);const u=this.make_DOM_svg(t,l,o,i).paper;let g=Math.min(u.height*Math.PI/(4*this.edo)/2-5,u.height*Math.PI/(c*c*2),u.height*Math.PI/(this.edo*c)/2-5);n&&(g=Math.max(g,n));for(let t of e){let e={paper:u,pitches:t,radius:a,ring:r,inner_strings:!1,node_radius:g,outer_strings:h};this.show.necklace(e),a-=p}},necklace_fractal:t=>{const e=t.container_id,i=t.necklaces,s=t.offset_x,r=t.offset_y||50,n=t.radius_multiplier||.5,h=t.initial_radius||250,o=t.minimum_node_radius||20,l=null==t.ring||t.ring,a=t.canvas_width||900,c=t.canvas_height||900,p=null!=t.replace&&t.replace,u=this.make_DOM_svg(e,a,c,p).paper,g=this,f=function(t,e,i=h){let a=[...t],c=a.splice(0,1)[0];if(e)e.forEach((t=>{let e=g.show.necklace({paper:u,ring:l,radius:i,pitches:c,cx:t.cx,cy:t.cy+i,PC_at_midnight:t.name,node_radius:Math.max(i/8,o)});a.length>0&&f(a,e.nodes,e.radius*n)}));else{let t=g.show.necklace({cx:u.width/2+s,ring:l,paper:u,radius:i,pitches:c,cy:i+r,node_radius:Math.max(i/8,o)});a.length>0&&f(a,t.nodes,t.radius*n)}};f(i)}};mod(t,e=this.edo){return(t%e+e)%e}}class a{constructor(t,e){this.parent=e,this.catalog={};let i=0-Math.min.apply(Math,t);this.pitches=t.map((t=>t+i)),this.edo=this.parent.edo,this.pitches=this.pitches.map((t=>t%e.edo)),this.pitches=this.parent.get.unique_elements(this.pitches),this.pitches.sort(((t,e)=>t-e)),this.length=this.count.pitches(),this.name=this.get.name()}count={chord_quality:t=>{this.pitches;let e=0;return t=this.parent.get.partitioned_subsets(t),this.parent.get.modes(this.pitches,!1,!1).forEach((i=>{t.forEach((t=>{-1==(t=t.map((t=>-1!=i.indexOf(t)))).indexOf(!1)&&e++}))})),e},consecutive_steps:t=>{let e=[],i=this.to.steps();if(i=[...i,...i],-1==i.indexOf(t))return 0;let s=0;for(let r of i)r==t?s++:(e.push(s),s=0);e=e.sort(((t,e)=>e-t));let r=e[0];return r=Math.min.apply(Math,[r,this.edo]),r},imperfections:(t=10,e=!1)=>{if(this.catalog["# imperfections"])return this.catalog["# imperfections"];let i=this.pitches,s=0,r=[],n=this.parent.convert.ratio_to_cents(1.5);for(let e=1;e<this.edo;e++)if(Math.abs(this.parent.convert.interval_to_cents(e)-n)<=t)r.push(e);else if(r.length>0)break;let h=i.map((t=>t+this.edo)),o=i.concat(h);return i.forEach((t=>{let e=!1;r.forEach((i=>{-1!=o.indexOf(t+i)&&(e=!0)})),e||s++})),e&&(this.catalog["# imperfections"]=s),s},interval:t=>{Array.isArray(t)||(t=[t]);let e=this.pitches,i=0;for(let s of e)for(let r of t)-1!=e.indexOf((s+r)%this.edo)&&i++;return i},M3s:()=>this.count.interval(this.parent.M3s),m3s:()=>this.count.interval(this.parent.m3s),major_minor_triads:()=>this.count.chord_quality([[...this.parent.M3s],[...this.parent.P5s]])+this.count.chord_quality([[...this.parent.m3s],[...this.parent.P5s]]),modes:()=>this.get.modes().length,n_chords:()=>{let t=1;for(let e=2;e<this.count.pitches();e++)t+=this.get.n_chords(e).length;return t},P5s:()=>this.count.interval(this.parent.P5s),pitches:()=>this.pitches.length,rahn_differences:()=>{let t=0;for(let e=1;e<this.count.pitches();e++){let i=this.get.generic_intervals(e);i=i.map((t=>t.instances)),t+=this.parent.get.n_choose_k(i,2).map((t=>t[0]*t[1])).reduce(((t,e)=>t+e),0)}return t},rahn_contradictions:()=>{let t=0,e=[...Array(this.pitches.length).keys()],i=this.parent.get.combinations(e,2).sort(((t,e)=>t[0]-e[0]||t[1]-e[1])).map((t=>{let e=this.get.pairwise_generic_specific_intervals(t[0],t[1]);return e.scale_degs=t,e.pitches=[this.pitches[t[0]],this.pitches[t[1]]],e}));for(let e=0;e<i.length-1;e++){let s=i[e];for(let r=e+1;r<i.length;r++){let e=i[r];(s.generic<e.generic&&s.specific>e.specific||e.generic<s.generic&&e.specific>s.specific)&&t++}}return t},rahn_ambiguities:()=>{let t=0,e=[...Array(this.pitches.length).keys()],i=this.parent.get.combinations(e,2).sort(((t,e)=>t[0]-e[0]||t[1]-e[1])).map((t=>{let e=this.get.pairwise_generic_specific_intervals(t[0],t[1]);return e.scale_degs=t,e.pitches=[this.pitches[t[0]],this.pitches[t[1]]],e}));for(let e=0;e<i.length-1;e++){let s=i[e];for(let r=e+1;r<i.length;r++){let e=i[r];s.specific==e.specific&&s.generic!=e.generic&&t++}}return t},ratio:(t,e=10)=>{let i=this.parent.convert.ratio_to_interval(t,e);return this.count.interval(i)},rotational_symmetries:()=>this.edo/this.count.transpositions(),simple_ratios:(t=17,e=15)=>{let i=this.parent.get.simple_ratios(t=t),s=0,r=0;for(let t in i){let n=this.count.ratio(i[t].value,e);n>0&&(s++,r+=n)}return{discrete:s,instances:r}},tetrachords:()=>this.get.tetrachords().length,thirds:()=>this.count.interval(this.parent.M3s.concat(this.parent.m3s)),transpositions:(t=!1)=>{if(this.catalog["# transpositions"])return this.catalog["# transpositions"];let e=this.pitches,i=[e];for(let t=0;t<this.parent.edo;t++){let s=[];if(e.forEach((e=>{s.push((e+t+1)%this.edo)})),s.sort(((t,e)=>t-e)),this.parent.is.element_of(s,i))return i.length;i.push(s)}let s=i.length;return t&&(this.catalog["# transpositions"]=s),s},trichords:()=>this.get.trichords().length,unique_elements:t=>{let e=this.pitches,i=e.length;return e.forEach((e=>{-1!=t.indexOf(e)&&i--})),i}};export={scala:(t,e="scala/")=>{let i=this.get.name(),s="! "+(t=t||i+".scl")+"\n";s+="!\n"+i+" "+JSON.stringify(this.get.pitches())+"\n",s+=String(this.count.pitches()+1)+"\n!\n";let n=this.to.cents();for(let t of n)s+=String(t)+"\n";s+="2/1",r(t,e,s)}};get={area:(t=.56418958354776)=>{this.edo;const e=this.get.coordinates([0,0],t);let i=0,s=0;for(let t=0;t<e.length;t++)i+=e[t][0]*e[(t+1)%e.length][1],s+=e[t][1]*e[(t+1)%e.length][0];return Math.abs((i-s)/2)},diagnostic_intervals:()=>{let t=[];for(let e=1;e<=Math.floor(this.edo/2);e++){let i=this.get.specific_intervals(e);if(!i)continue;if(0==i.length)continue;let s=!0;i.forEach((t=>{1!=t.instances&&(s=!1)})),s&&t.push(i[0].specific)}return t},set_difference:(t=[0,2,4,5,7,9,11],e=!1,i=1)=>{let s=e?this.count.pitches():1,r=[],n=[],h=[],o=[];for(let e=0;e<s;e++){let s=this.mode(e).pitches,l=[];for(let e=0;e<s.length;e++)l.push(s[e]-t[e]);let a=l.map((t=>Math.abs(t)<=i)).reduce(((t,e)=>t&&e),!0),c=l.reduce(((t,e)=>0!=e?t+1:t),0);r.push(l),n.push(a),o.push(e),h.push(c)}for(let t=n.length-1;t>=0;t--)n[t]||(n.splice(t,1),r.splice(t,1),h.splice(t,1),o.splice(t,1));let l=Math.min(...h),a=h.indexOf(l);return{valid:n[a]||!1,alterations:h[a],delta:r[a],mode:n[a]?this.mode(o[a]).pitches:void 0}},per_note_set_difference:(t=[0,2,4,5,7,9,11])=>this.pitches.map(((e,i)=>t[i]-e)),coordinates:(t=[0,0],e=.56418958354776)=>this.parent.get.coordinates(this.pitches,t,e),common_tone_transpositions:t=>{let e=this.get.modes(),i=[];return this.pitches.forEach((s=>{e.forEach(((e,r)=>{let n=e.map((t=>this.parent.mod(t+s,this.edo)));t&&(n=n.sort(((t,e)=>t-e)));let h=this.parent.count.common_tones(this.pitches,n);i.push({transposition:n,common_tones:h,altered_tones:this.count.pitches()-h,common_tone:s,as_scale_degree:r+1})}))})),i=this.parent.get.unique_elements(i),i},complement:t=>this.parent.get.complementary_set(this.pitches,t),chord_quality_from_shape:(t,e=1)=>(t=t.map((t=>0==(t=this.parent.mod(t,this.pitches.length))?this.pitches.length:t))).map((t=>{let i=this.parent.mod(t+e-2,this.pitches.length);return this.pitches[i]})),melody_from_intervals:(t,e=1,i=0)=>{let s=[e];t.forEach((t=>{let e=s[s.length-1];s.push(e+t)}));let r=s.map((t=>this.get.pitches()[this.parent.mod(t-1,this.count.pitches())]+Math.floor((t-1)/this.count.pitches())*this.edo));return r=r.map((t=>t+(i-r[0]))),r},generic_intervals:(t=1)=>{let e=[],i=t;if(i<1)return NaN;let s=this.parent.mod,r=this.pitches,n=r.length,h={};for(let t=0;t<n;t++){let e=r[t],o=r[s(t+i,n)],l=s(o-e,this.edo);h[l]?h[l].push([e,o]):h[l]=[[e,o]]}for(let t in h)e.push({generic:i,specific:parseInt(t),instances:h[t].length,pitches:h[t]});return e},specific_intervals:(t=1)=>{let e=[],i=t,s=this.parent.mod,r=this.pitches,n=r.length,h={};for(let t=0;t<n;t++)t:for(let e=1;e<n;e++){let o=r[t],l=r[s(t+e,n)],a=s(l-o,this.edo);if(a==i){h[e]?h[e].push([o,l]):h[e]=[[o,l]];break t}if(a>i)break t}for(let t in h)e.push({generic:t,specific:i,pitches:h[t],instances:h[t].length});return e},interval_vector:(t=!1)=>{if(this.catalog["interval vector"])return this.catalog["interval vector"];let e=Math.floor(this.edo/2),i=Array.from(new Array(e).fill(0)),s=this.get.normal_order();for(let t=0;t<s.length-1;t++)for(let r=t+1;r<s.length;r++){let n=s[r]-s[t];n>e&&(n=this.edo-n),0==n&&(n=e),i[n-1]++}return t&&(this.catalog["interval vector"]=i),i},inversion:(t=!1)=>{if(this.catalog.inverted)return this.catalog.inverted;let e=this.parent.get.inversion(this.pitches,!1);return e},least_step_multiplier:()=>{let t=this.get.step_sizes();if(1==t.length)return 1;let e=this.edo;for(let i=0;i<t.length-1;i++)t[i+1]/t[i]<e&&(e=t[i+1]/t[i]);return e},lerdahl_attraction:(t,e)=>{if(t==e)return 0;e={pitch:e};const i=t=>0==t?4:this.parent.P5s.indexOf(t)>=0||this.parent.M3s.indexOf(t)>=0?3:1;(t={pitch:t}).anchoring=i(t.pitch),e.anchoring=i(e.pitch);let s=Math.abs(t.pitch-e.pitch);return s>this.edo/2&&(s=this.edo-s),s=12*s/this.edo,e.anchoring==t.anchoring?0:e.anchoring/t.anchoring*(1/s)},lerdahl_attraction_vector:()=>{let t=[];for(let e=0;e<this.pitches.length;e++){let i=this.pitches[e],s=this.pitches[this.parent.mod(e-1,this.pitches.length)],r=this.pitches[this.parent.mod(e+1,this.pitches.length)];s=this.get.lerdahl_attraction(i,s),r=this.get.lerdahl_attraction(i,r),s<1&&r<1?t.push("*"):s<1&&r>=1?t.push(">>"):s>=1&&r<1?t.push("<<"):s>=1&&r>=1&&t.push("<>")}return t},levenshtein:(t,e=!1)=>this.parent.get.levenshtein(this.pitches,t,e),myhill_property:(t=2)=>{let e={},i=this.parent.mod,s=this.count.pitches(),r=this.pitches;for(let n=1;n<s;n++){e[n]=new Set;for(let h=0;h<s;h++)if(e[n].add(i(r[i(h+n,s)]-r[h],this.edo)),e[n].size>t)return!1}for(let i=1;i<s;i++)if(e[i].size!=t)return!1;return!0},modes:(t=!1)=>{if(this.catalog.modes)return this.catalog.modes;let e=this.parent.get.modes(this.pitches);return t?this.catalog.modes=e:e},motives_diatonic:(t,e=!1,i=8)=>{let s=this.pitches;if(t.filter((t=>-1==s.indexOf(this.parent.mod(t,this.edo)))).length>0)return null;s=this.parent.get.unique_elements(s).sort(((t,e)=>t-e));let r=t.map((t=>s.indexOf(t)+1));return this.parent.get.motives(r,!0,e,i)},n_chords:(t,e=!0,i=!1)=>{if(this.catalog.n_chords){if(Array.isArray(this.catalog.n_chords[t]))return this.catalog.n_chords[t]}else this.catalog.n_chords={};let s=[];this.pitches,this.pitches.slice(0,t-1);const r=(i=0,n=[])=>{if(n.length!=t)for(let e=i;e<this.pitches.length+(t-1);e++)r(e+1,[...n,this.pitches[this.parent.mod(e,this.pitches.length)]]);else this.parent.get.unique_elements(n).length==n.length&&(n=n.sort(((t,e)=>t-e)),e&&(n=this.parent.get.normal_order(n)),s.push(n))};return r(),s=this.parent.get.unique_elements(s),i&&(this.catalog.n_chords[t]=s),s},n_chords_diatonic:t=>{let e=new l(this.count.pitches()).scale(Array.from(Array(this.count.pitches()).keys())).get.n_chords(t);this.get.modes();let i=e.map((t=>{let e=this.parent.convert.to_steps(t);return this.get.steps_to_qualities(e)}));return i=i.map((t=>(t.combos=t.combos.sort(((t,e)=>t.positions.length-e.positions.length)),t))),i},name:()=>{let t=this.get.normal_order(),e=0;return t.forEach((t=>{e+=Math.pow(2,t)})),String(this.parent.edo)+"-"+String(parseInt(e))},neighborhood:(t=1,e=1,i=!0,s=!0)=>{let r=this.count.pitches(),n=this.parent,h=this.pitches,o=Array.from(Array(t).keys()).map((t=>[t+1,-(t+1)])).flat(),l=Array.from(Array(e),(()=>Array.from(Array(r)).map((t=>0))));l=l.map(((t,e)=>(t=Array.from(Array(e+1).fill(1)).concat(t).slice(0,r),t=this.parent.get.unique_elements(this.parent.get.permutations(t))))).flat();const a=function(t,e,i){let s=[];for(let r=0;r<i.length;r++){let h=Array.from(t);h[e]=n.mod(h[e]+i[r],n.edo),s.push(h)}return s};return l=l.map((t=>{let e=[Array.from(h)],i=t.reduce(((t,e,i)=>1===e?t.concat(i):t),[]);for(let t=0;t<i.length;t++)e=e.map((e=>a(e,i[t],o))).flat();return e})).flat(),i&&(l=l.map((t=>n.get.normal_order(t)))),s&&(l=l.filter((t=>t.length==r))),l=n.get.unique_elements(l),l},normal_order:(t=!1)=>{if(this.catalog.normal_order)return this.catalog.normal_order;let e=this.pitches,i=this.parent.get.normal_order(e,!1);return i},pairwise_generic_specific_intervals:(t,e)=>{let i=this.parent.mod,s=this.pitches,r=s.length;return{specific:i(s[i(e,r)]-s[i(t,r)],this.edo),generic:i(e-t,r)}},permutations:()=>this.parent.get.permutations(this.pitches),pitches:()=>this.pitches,position_of_quality:t=>{let e=[],i=[...this.pitches,...this.pitches];for(let s of this.pitches){let r=[...t.map((t=>(t+s)%this.edo))];this.parent.is.subset(r,i)&&e.push(s)}return e},prime_form:(t=!1)=>{if(this.catalog["prime form"])return this.catalog["prime form"];let e=this.parent.scale(this.get.inversion()),i=this.parent.scale(this.get.normal_order()),s=this.parent.scale(e.get.normal_order()),r=i.to.steps(),n=s.to.steps(),h=i.pitches;for(let t=0;t<r.length;t++){if(r[t]<n[t]){h=i.pitches;break}if(r[t]>n[t]){h=s.pitches;break}}return t&&(this.catalog["prime form"]=h),h},product:(t,e=!1)=>{let i=this.pitches.map((e=>this.parent.mod(e*t,this.edo)));return e&&(i=i.sort(((t,e)=>t-e))),i},quality_with_intervals:(t=[7],e)=>{let i=[],s=this.edo,r=function(t,e,i,n){if(i||(i=t.length),n||(n=[t.shift()]),n.length==i)return n;let h=e.map((h=>{let o=(n[n.length-1]+h)%s,l=t.indexOf(o);if(-1==l)return!1;{let s=[...t];s.splice(l,1);let h=[...n,o];return r(s,e,i,h)}})).reduce(((t,e)=>e?[...t,e]:t),[]).flat();const o=function(t,e){if(!t.length)return[];const i=t.slice(0,e),s=t.slice(e);return[i,...o(s,e)]};return o(h.flat(),i)},n=this.parent.get.rotations(this.pitches);for(let s=0;s<n.length;s++)i=i.concat(r(n[s],t,e));return i},rotations:()=>{let t=[],e=[...this.pitches];for(;!this.parent.is.element_of(e,t);)t.push(e),e=[...e.slice(1),...e.slice(0,1)];return t},rothenberg_propriety:(t=!1)=>{if(this.catalog.rothenberg)return this.catalog.rothenberg;let e=this.pitches,i=[],s=Array(e.length-1).fill(0).map(((t,e)=>e+1)),r=this.to.steps();s.forEach((t=>{let e=r.concat(r),s=[];for(let i=0;i<r.length;i++){let r=e.slice(i,i+t);r=r.reduce(((t,e)=>t+e)),s.push(r)}i.push({min:Math.min.apply(Math,s),max:Math.max.apply(Math,s)})}));let n=!0,h=!0;for(let t=1;t<i.length;t++)i[t].min<=i[t-1].max&&(n=!1),i[t].min<i[t-1].max&&(h=!1);let o="";return o=n?"strictly proper":h?"proper":"improper",t&&(this.catalog.rothenberg=o),o},roughness:(t=!1,e=440)=>{const i=function(t){let i=t.parent.get.n_choose_k(t.pitches,2);return i=i.map((i=>t.parent.convert.midi_to_freq(i,69,e))).map((e=>t.parent.get.sine_pair_dissonance(e[0],e[1],1,1))).reduce(((t,e)=>t+e),0),i};if(t){let t=[];for(let e=0;e<this.count.pitches();e++)t.push(i(this.mode(e)));return t}return i(this)},sameness_quotient:()=>1-this.count.rahn_differences()/this.parent.get.maximal_rahn_difference(this.count.pitches()),coherence_quotient:()=>1-(this.count.rahn_ambiguities()+this.count.rahn_contradictions())/this.parent.get.maximal_carey_coherence_failures(this.count.pitches()),scale_degree_transpositions:(t=!0)=>{let e=[],i=this.to.steps();i=i.slice(0,-1);for(let s of this.pitches){let r=[s];for(let t of i){let e=this.parent.mod(r.slice(-1)[0]+t,this.edo);r.push(e)}t&&r.sort(((t,e)=>t-e));let n=this.count.pitches()-this.parent.count.common_tones(this.pitches,r);e.push([r,n])}return e.sort(((t,e)=>t[1]-e[1])),e=this.parent.get.unique_elements(e),e},segments:()=>{let t=this.to.steps(),e=[];for(;t.length>0;){let i=t.splice(0,1);for(;t[0]==i[0];)i.push(t.splice(0,1)[0]);e.push(i)}return e},sequence_transposition:(t,e)=>{let i=this.parent.mod,s=[];for(let r of t){let t=this.pitches.indexOf(i(r,this.edo)),n=Math.floor(r/this.edo);t+=e,n+=Math.floor(t/this.pitches.length),t=i(t,this.pitches.length);let h=this.pitches[t]+this.edo*n;s.push(h)}return s},shortest_path:(t,e=1,i=-1)=>{let s=new l(this.count.pitches()).get.shortest_path(t-1,e,i);console.log(s)},stacks:(t,e)=>{this.pitches;let i=(e+1)*(t-1)+1,s=this.get.modes(),r=[];return s.forEach((s=>{let n=[];for(let t=0;t<i;t+=e+1)n.push(s[t%s.length]);new Set(n).size==t&&r.push(n)})),r=this.parent.get.unique_elements(r),r},step_sizes:(t=!1)=>{if(this.catalog["step sizes"])return this.catalog["step sizes"];let e=this.parent.get.unique_elements(this.to.steps());return e.sort(((t,e)=>t-e)),t&&(this.catalog["step sizes"]=e),e},steps_to_qualities:t=>{let e=this.get.modes();t=this.parent.convert.intervals_to_pitches(t);let i=e.map((e=>t.map((t=>e[t]))));return i=i.map((t=>this.parent.get.normal_order(t))),i=this.parent.get.unique_elements(i),i=i.map((t=>({quality:t,positions:this.get.position_of_quality(t)}))),{steps:this.parent.convert.to_steps(t),combos:i}},supersets:t=>{let e=[];for(let i of t){let t=this.parent.get.modes(i);for(let s of t)this.is.subset(s)&&e.push(i)}return e=this.parent.get.unique_elements(e),e},tetrachords:(t=!1)=>{if(this.catalog.tetrachords)return this.catalog.tetrachords;let e=this.get.n_chords(4,!0,t);return t&&(this.catalog.tetrachords=e),e},scale_degree_roles:t=>{if(12!=this.edo&&!t)return[];return t||(t={0:[1],1:[2],2:[2],3:[2,3],4:[3],5:[4],6:[4],7:[5],8:[6],9:[6],10:[6,7],11:[7]}),this.parent.get.partitioned_subsets(this.pitches.map((e=>t[e])))},transposition:t=>this.parent.get.transposition(this.pitches,t),transpositions_with_pitches:t=>{let e=[];for(let t=0;t<this.edo;t++){let i=this.parent.get.starting_at(this.pitches,t);e.push({pitches:i,common_tones:this.count.pitches()-this.get.levenshtein([...i].sort(((t,e)=>t-e)))})}return e=e.filter((e=>{let i=t.map((t=>-1!=e.pitches.indexOf(t)));return i=i.reduce(((t,e)=>t*e),!0),i})),e=e.sort(((t,e)=>e.common_tones-t.common_tones)),e},trichords:(t=!1)=>{if(this.catalog.trichords)return this.catalog.trichords;let e=this.get.n_chords(3,!0,t);return t&&(this.catalog.trichords=e),e},without:(t,e=!1)=>this.parent.get.without(this.pitches,t,e)};is={deep:()=>{let t=this.get.interval_vector(),e=new Set(this.get.interval_vector());return t.length==e.size},distributionally_even:()=>{let t={};for(let e=1;e<this.count.pitches();e++){this.get.generic_intervals(e).forEach((e=>t[e.generic]?t[e.generic].push(e.specific):t[e.generic]=[e.specific]))}for(let e=1;e<this.count.pitches();e++)if(t[String(e)].length>2)return!1;return!0},in_lower_edos:(t=!1)=>{if(this.catalog["lower EDOs"])return this.catalog["lower EDOs"];let e=this.pitches,i=[];for(let t of this.parent.edo_divisors){let s=!0;for(let i of e)if(i%t!=0){s=!1;break}s&&i.push(parseInt(this.edo/t))}return t&&(this.catalog["lower EDOs"]=i),i},invertible:(t=!1)=>{if(this.catalog.invertible)return this.catalog.invertible;let e=this.get.normal_order(),i=this.parent.scale(this.get.inversion()).get.normal_order(),s=!0;return this.parent.is.same(e,i)&&(s=!1),t&&(this.catalog.invertible=s),s},maximally_even:()=>{let t={};for(let e=1;e<this.count.pitches();e++){this.get.generic_intervals(e).forEach((e=>t[e.generic]?t[e.generic].push(e.specific):t[e.generic]=[e.specific]))}for(let e=1;e<this.count.pitches();e++){if(t[String(e)].length>2)return!1;if(2==t[String(e)].length&&1!=Math.abs(t[String(e)][0]-t[String(e)][1]))return!1}return!0},myhill_property:()=>this.get.myhill_property(),mode_of:t=>{let e=this.parent.get.modes(t);return this.parent.is.element_of(this.pitches,e)},MOLT:()=>this.count.transpositions()<this.edo,normal_order:()=>this.parent.is.same(this.pitches,this.get.normal_order()),one_of:t=>{let e=this.pitches,i=t.map((t=>this.parent.get.modes(t)));return i=i.flat(1),!!this.parent.is.element_of(e,i)},prime_form:()=>this.parent.is.same(this.pitches,this.get.prime_form()),subset:t=>{const e=function(t,e){for(let i of t)if(-1==e.indexOf(i))return!1;return!0};Array.isArray(t[0])||(t=[t]),t=t.map((t=>this.parent.scale(t).get.modes())).flat();for(let i of t)if(e(this.pitches,i))return!0;return!1}};to={cents:()=>this.pitches.map((t=>t*this.parent.cents_per_step)),steps:(t=!1)=>{if(this.catalog.steps)return this.catalog.steps;let e=this.parent.convert.to_steps(this.pitches.concat([this.edo]),!1);return e}};show={interval_fractal_tree:(t,e=200,i=90,s=[-1,1],r=5,n=.7)=>{this.parent.show.interval_fractal_tree(t,e,i,this.pitches,s,r,n)},necklace:(t,e=!0,i=600)=>this.parent.show.necklace(t,this.pitches,e,i)};mode(t=0){let e=this.get.modes(),i=e[this.parent.mod(t,e.length)];return new a(i,this.parent)}invert(){let t=this.get.inversion();return new a(t,this.parent)}normal(){let t=this.get.normal_order();return new a(t,this.parent)}prime(){let t=this.get.prime_form();return new a(t,this.parent)}complement(){let t=this.get.complement(!0);return new a(t,this.parent)}}module.exports={EDO:l,Scale:a,Time:class{constructor(){}get={subdivisions:(t,e=1,i=t)=>new l(t).get.scales(e,i).map((t=>t.to.steps())),ratios:(t=1,e=10)=>{let i={};for(let s=1;s<=e;s++)i[s]=t*s,1!=s&&(i["1/"+String(s)]=t/s);return i},fractal:(t=[2,2,3],e=1)=>{const i=function(e,s){return s<=1?e:(s--,e=e.map((e=>t.map((t=>t*e)))).flat(),i([...e],s))};return i([...t],e)},beat:t=>{let e=[],i=Math.min(...t),s=Math.max(...t),r=new l;for(let n=i;n<=s;n++){let i=0,s=r.convert.intervals_to_pitches(t).slice(1);for(let e=0;e<t.length;e++){let h=s.filter((t=>Math.round(t/n)==t/n)).length;h>i&&(i=h),s=r.convert.intervals_to_pitches(t.slice(e)).slice(1)}0!=i&&e.push([n,i])}return e=e.sort(((t,e)=>e[1]-t[1])),e},repeated:(t,e=2)=>Array.from(new Array(e),(()=>t)).flat(),motives:(t,e=8,i=!1)=>(new l).get.motives(t,!1,!1,e).filter((t=>(t.incidence>1||i)&&t.motive.length>1)),relational_motives:(t,e=8,i=!1)=>{let s=this.convert.beats_to_ratios(t),r=this.get.motives(s,e,i),n=new l;return r=r.map((t=>{let e=n.get.subset_indices(t.motive,s,!1).map((t=>t[0]));return t.position=e,t})),r},explicit:(...t)=>t=t.map((t=>(t=t.map((t=>t=(t=[String(t),...Array.from(Array(t-1).fill("."))]).map((t=>1==t.length?t+" ":t))))).flat().join(" "))),counterpoint_cycle:(...t)=>{let e=(t=t.map((t=>Array.isArray(t)?t:[t])).map((t=>this.convert.binary(t)))).map((t=>t.length)),i=e.reduce(((t,e)=>t*e),1),s=!1;for(i=Math.max(...e);!s&&(s=Boolean(e.map((t=>Number(Number.isInteger(i/t)))).reduce(((t,e)=>t*e),1)),!s);)i++;return t=t.map((t=>this.get.repeated(t,i/t.length)))}};resize={by_product:(t,e=1,i=!1,s=!1)=>(t=t.map((t=>t*e)).map((t=>{switch(i){case"closest":return Math.round(t);case"down":return Math.floor(t);case"up":return Math.ceil(t);case!1:return t}})),s&&(t=t.filter((t=>0!=t))),t),by_sum:(t,e,i)=>i?t.map((t=>t+e)).filter((t=>0!=t)):t.map((t=>t+e))};convert={binary:t=>t.map((t=>0==t?[0]:((t=Array.from([...new Array(t).fill(0)]))[0]=1,t))).flat(),beats_to_tempo:(t=4,e=6,i=60)=>e/t*i,beats_to_ratios:(t,e=!1)=>t.map(((t,i,s)=>i>0?s[i]/s[e?0:i-1]:1)).slice(1),beats_to_msec:(t,e=60,i=1)=>t.map((t=>60/e*1e3*t/i))}}}}();
